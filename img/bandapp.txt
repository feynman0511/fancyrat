import streamlit as st
import pandas as pd
import altair as alt

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆINOUEã ã‘å¼·èª¿ï¼‰
st.markdown(
    """
    <style>
    h1 {
        font-family: 'Times New Roman', serif;
        font-size: 45px;
        font-weight: bold;
        color: crimson;
        text-align: center;
        white-space: nowrap;
    }
    </style>
    """,
    unsafe_allow_html=True
)

# ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆINOUEã ã‘å¼·èª¿ï¼‰



st.title('Image Quality Measurement App')

st.markdown('Developed by INOUE')
# st.markdown(
#     "<h1>"
#     "<span style='color:crimson;'>I</span>nnovative "
#     "<span style='color:crimson;'>N</span>umerical "
#     "<span style='color:crimson;'>O</span>ptimized "
#     "<span style='color:crimson;'>U</span>nique "
#     "<span style='color:crimson;'>E</span>xperience Apps"
#     "</h1>",
#     unsafe_allow_html=True
# )

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UI
st.markdown("### ğŸ“‚ csvãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„")
uploaded_file = st.file_uploader("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ", type=["csv"])

# ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§é¸æŠ
selected_option = st.selectbox(
    "ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ",
    ["dLstr", "BG", "dE"]
)


# ------------------------------------------------------------------------------
# ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
st.sidebar.header("è¡¨ç¤ºç¯„å›²ã®è¨­å®š")

# å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
if selected_option == "dLstr":
    # dLstr: æ¨ªè»¸0~400ã€ç¸¦è»¸0~10
    x_min, x_max = st.sidebar.slider("Xè»¸ã®ç¯„å›² (Pitch/mm)", 0, 400, (0, 400))
    y_min, y_max = st.sidebar.slider("Yè»¸ã®ç¯„å›² (dLstr)", 0.0, 10.0, (0.0, 10.0))
elif selected_option == "BG":
    # BG: æ¨ªè»¸0~100ã€ç¸¦è»¸0~10
    x_min, x_max = st.sidebar.slider("Xè»¸ã®ç¯„å›² (Pitch)", 0, 100, (0, 100))
    y_min, y_max = st.sidebar.slider("Yè»¸ã®ç¯„å›² (BG)", 0.0, 10.0, (0.0, 10.0))
elif selected_option == "dE":
    # dE: æ¨ªè»¸0~100ã€ç¸¦è»¸0~10
    x_min, x_max = st.sidebar.slider("Xè»¸ã®ç¯„å›² (Pitch)", 0, 100, (0, 100))
    y_min, y_max = st.sidebar.slider("Yè»¸ã®ç¯„å›² (dE)", 0.0, 10.0, (0.0, 10.0))

if uploaded_file is not None:
    try:
        # CSVèª­ã¿è¾¼ã¿
        df = pd.read_csv(uploaded_file, header=None)

# ------------------------------------------------------------------------------
# ä»¥ä¸‹dLstr

        if selected_option == "dLstr":
            # Aåˆ—ã§"Position[mm]"ã®ã‚»ãƒ«ã‚’æ¢ã™
            pos_index = df[df.iloc[:, 0] == "Position[mm]"].index
            if len(pos_index) == 0:
                raise ValueError("Aåˆ—ã« 'Position[mm]' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_x = pos_index[0] + 1

            # Aåˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—
            x_vals = pd.to_numeric(df.iloc[start_x:, 0], errors='coerce')
            x_data = x_vals[x_vals.notna()]

            # Eåˆ—ã§"V"ã®ã‚»ãƒ«ã‚’æ¢ã™
            v_index = df[df.iloc[:, 4] == "V"].index
            if len(v_index) == 0:
                raise ValueError("Eåˆ—ã« 'V' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_y = v_index[0] + 1

            # Eåˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—
            y_vals = pd.to_numeric(df.iloc[start_y:, 4], errors='coerce')
            y_data = y_vals[y_vals.notna()]

            # é•·ã•ã‚’åˆã‚ã›ã¦DataFrameã«ã¾ã¨ã‚ã‚‹ï¼ˆçŸ­ã„æ–¹ã«åˆã‚ã›ã‚‹ï¼‰
            min_len = min(len(x_data), len(y_data))
            data = pd.DataFrame({
                'X': x_data.iloc[:min_len].values,
                'Y': y_data.iloc[:min_len].values
            })

            # ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸Šé™ã‚’ç„¡è¦–ï¼‰
            filtered_data = data[(data['X'] >= x_min) & (data['X'] <= x_max) &
                                 (data['Y'] >= y_min) & (data['Y'] <= y_max)]

            # ã‚°ãƒ©ãƒ•ä½œæˆ
            chart = alt.Chart(filtered_data).mark_line(opacity=0.8,clip=True).encode(
                x=alt.X('X', title='Pitch / mm', scale=alt.Scale(domain=[x_min, x_max])),
                y=alt.Y('Y', title='dLstr', scale=alt.Scale(domain=[y_min, y_max]))
            ).properties(
                width=700,
                height=400
            ).interactive()

            st.altair_chart(chart)

# ------------------------------------------------------------------------------
# ä»¥ä¸‹BG

        elif selected_option == "BG":
            # Iåˆ—ã§"Pitch[mm]"ã®ã‚»ãƒ«ã‚’æ¢ã™
            pitch_index = df[df.iloc[:, 8] == "Pitch[mm]"].index
            if len(pitch_index) == 0:
                raise ValueError("Iåˆ—ã« 'Pitch[mm]' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_x = pitch_index[0] + 1

            # Iåˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—ï¼ˆæ¨ªè»¸ï¼‰
            x_vals = pd.to_numeric(df.iloc[start_x:, 8], errors='coerce')
            x_data = x_vals[x_vals.notna()]

            # Råˆ—ã§"B.G."ã®ã‚»ãƒ«ã‚’æ¢ã™
            bg_index = df[df.iloc[:, 17] == "B.G."].index
            if len(bg_index) == 0:
                raise ValueError("Råˆ—ã« 'B.G.' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_y = bg_index[0] + 1

            # Råˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—ï¼ˆç¸¦è»¸ï¼‰
            y_vals = pd.to_numeric(df.iloc[start_y:, 17], errors='coerce')
            y_data = y_vals[y_vals.notna()]

            # é•·ã•ã‚’åˆã‚ã›ã¦DataFrameã«ã¾ã¨ã‚ã‚‹ï¼ˆçŸ­ã„æ–¹ã«åˆã‚ã›ã‚‹ï¼‰
            min_len = min(len(x_data), len(y_data))
            data = pd.DataFrame({
                'X': x_data.iloc[:min_len].values,
                'Y': y_data.iloc[:min_len].values
            })

            # ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸Šé™ã‚’ç„¡è¦–ï¼‰
            filtered_data = data[(data['X'] >= x_min) & (data['X'] <= x_max) &
                                 (data['Y'] >= y_min) & (data['Y'] <= y_max)]

            # ã‚°ãƒ©ãƒ•ä½œæˆ
            chart = alt.Chart(filtered_data).mark_line().encode(
                x=alt.X('X', title='Pitch / mm', scale=alt.Scale(domain=[x_min, x_max])),
                y=alt.Y('Y', title='BG', scale=alt.Scale(domain=[y_min, y_max]))
            ).properties(
                width=700,
                height=400
            ).interactive()

            st.altair_chart(chart)

# ------------------------------------------------------------------------------
# ä»¥ä¸‹dE

        elif selected_option == "dE":
            # Iåˆ—ã§"Pitch[mm]"ã®ã‚»ãƒ«ã‚’æ¢ã™
            pitch_index = df[df.iloc[:, 8] == "Pitch[mm]"].index
            if len(pitch_index) == 0:
                raise ValueError("Iåˆ—ã« 'Pitch[mm]' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_x = pitch_index[0] + 1

            # Iåˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—ï¼ˆæ¨ªè»¸ï¼‰
            x_vals = pd.to_numeric(df.iloc[start_x:, 8], errors='coerce')
            x_data = x_vals[x_vals.notna()]

            # Såˆ—ã§"P_dE"ã®ã‚»ãƒ«ã‚’æ¢ã™
            de_index = df[df.iloc[:, 18] == "P_dE"].index
            if len(de_index) == 0:
                raise ValueError("Såˆ—ã« 'P_dE' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            start_y = de_index[0] + 1

            # Såˆ—ã®æ•°å€¤ãŒç¶šãç¯„å›²ã‚’å–å¾—ï¼ˆç¸¦è»¸ï¼‰
            y_vals = pd.to_numeric(df.iloc[start_y:, 18], errors='coerce')
            y_data = y_vals[y_vals.notna()]

            # é•·ã•ã‚’åˆã‚ã›ã¦DataFrameã«ã¾ã¨ã‚ã‚‹ï¼ˆçŸ­ã„æ–¹ã«åˆã‚ã›ã‚‹ï¼‰
            min_len = min(len(x_data), len(y_data))
            data = pd.DataFrame({
                'X': x_data.iloc[:min_len].values,
                'Y': y_data.iloc[:min_len].values
            })

            # ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸Šé™ã‚’ç„¡è¦–ï¼‰
            filtered_data = data[(data['X'] >= x_min) & (data['X'] <= x_max) &
                                 (data['Y'] >= y_min) & (data['Y'] <= y_max)]

            # ã‚°ãƒ©ãƒ•ä½œæˆ
            chart = alt.Chart(filtered_data).mark_line().encode(
                x=alt.X('X', title='Pitch / mm', scale=alt.Scale(domain=[x_min, x_max])),
                y=alt.Y('Y', title='dE', scale=alt.Scale(domain=[y_min, y_max]))
            ).properties(
                width=700,
                height=400
            ).interactive()

            st.altair_chart(chart)

    except Exception as e:
        st.error(f"âŒ æœ‰åŠ¹ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼å†…å®¹: {str(e)}")
else:
    st.info("ğŸ“„ å¯¾å¿œå½¢å¼: CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.csvï¼‰")
